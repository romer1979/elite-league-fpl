<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>{{ ar.app_title }} - {{ ar.fpl_tracker }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Elite League" class="logo-img">
                <div class="logo-text">
                    <span class="logo-title">ÿØŸàÿ±Ÿä ÿßŸÑŸÜÿÆÿ®ÿ©</span>
                    <span class="logo-subtitle">ELITE LEAGUE</span>
                </div>
            </div>
            <div class="gameweek-info">
                <span class="gw-label">{{ ar.gameweek }}</span>
                <span class="gw-number">{{ data.gameweek or '-' }}</span>
                {% if data.gw_finished %}
                    <span class="status-badge finished">‚úÖ {{ ar.finished }}</span>
                {% elif data.is_live %}
                    <span class="status-badge live">üî¥ {{ ar.live }}</span>
                {% elif data.showing_previous_gw %}
                    <span class="status-badge not-started">‚è≥ {{ ar.not_started }}</span>
                {% else %}
                    <span class="status-badge">{{ ar.in_progress }}</span>
                {% endif %}
                <button class="refresh-btn" onclick="refreshDashboard()" id="refresh-btn">üîÑ</button>
                <a href="/stats" class="stats-link">üìä {{ ar.stats }}</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        {% if not data.success %}
            <div class="error-box">
                <h2>‚ö†Ô∏è {{ ar.error }}</h2>
                <p>{{ data.error }}</p>
            </div>
        {% else %}
            <div class="dashboard-grid">
                <!-- Fixtures Section -->
                <section class="fixtures-section">
                    <h2 class="section-title">
                        ‚öîÔ∏è {{ ar.fixtures }}
                        {% if data.is_live %}
                            <span class="live-badge">üî¥ {{ ar.live }}</span>
                        {% elif data.showing_previous_gw %}
                            <span class="prev-gw-badge">{{ ar.gameweek }} {{ data.fixtures_gameweek }}</span>
                        {% elif data.gw_finished %}
                            <span class="finished-badge">{{ ar.gameweek }} {{ data.fixtures_gameweek }}</span>
                        {% endif %}
                    </h2>
                    
                    {% if data.fixtures %}
                        <!-- Desktop Table View -->
                        <div class="fixtures-table-container desktop-only">
                            <table class="fixtures-table">
                                <thead>
                                    <tr>
                                        <th>{{ ar.team_1 }}</th>
                                        <th>{{ ar.score }}</th>
                                        <th>{{ ar.team_2 }}</th>
                                        <th>{{ ar.points_diff }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for match in data.fixtures %}
                                    <tr class="fixture-row">
                                        <td class="team-cell {% if match.winner == 1 %}winner{% endif %}">
                                            <div class="team-info-cell">
                                                <span class="team-name">
                                                    {% if match.winner == 1 %}<span class="winner-icon">‚úì</span>{% endif %}
                                                    <a href="https://fantasy.premierleague.com/entry/{{ match.entry_1 }}/event/{{ data.gameweek }}" target="_blank" class="manager-link">{{ match.team_1_name }}</a>
                                                </span>
                                                <span class="team-details">
                                                    <span class="captain-badge" title="{{ ar.captain }}">üëë {{ match.team_1_captain }}</span>
                                                    <span class="chip-badge {% if match.team_1_chip_active %}active{% else %}inactive{% endif %}">
                                                        {{ match.team_1_chip }}
                                                    </span>
                                                </span>
                                            </div>
                                        </td>
                                        <td class="score-cell">
                                            <span class="score {% if match.winner == 1 %}score-win{% endif %}">{{ match.team_1_points }}</span>
                                            <span class="vs">-</span>
                                            <span class="score {% if match.winner == 2 %}score-win{% endif %}">{{ match.team_2_points }}</span>
                                        </td>
                                        <td class="team-cell {% if match.winner == 2 %}winner{% endif %}">
                                            <div class="team-info-cell">
                                                <span class="team-name">
                                                    {% if match.winner == 2 %}<span class="winner-icon">‚úì</span>{% endif %}
                                                    <a href="https://fantasy.premierleague.com/entry/{{ match.entry_2 }}/event/{{ data.gameweek }}" target="_blank" class="manager-link">{{ match.team_2_name }}</a>
                                                </span>
                                                <span class="team-details">
                                                    <span class="captain-badge" title="{{ ar.captain }}">üëë {{ match.team_2_captain }}</span>
                                                    <span class="chip-badge {% if match.team_2_chip_active %}active{% else %}inactive{% endif %}">
                                                        {{ match.team_2_chip }}
                                                    </span>
                                                </span>
                                            </div>
                                        </td>
                                        <td class="diff-cell">
                                            <span class="diff-badge">{{ match.points_diff }}</span>
                                            <button class="toggle-unique-btn" onclick="toggleUnique({{ loop.index }})">‚ñº</button>
                                        </td>
                                    </tr>
                                    <tr class="unique-players-row" id="unique-row-{{ loop.index }}" style="display: none;">
                                        <td colspan="4">
                                            <div class="unique-players-container">
                                                <div class="unique-team unique-team-1">
                                                    <span class="unique-label">{{ match.team_1_name }}:</span>
                                                    <div class="unique-players-list">
                                                        {% for player in match.team_1_unique %}
                                                            <span class="unique-player-tag status-{{ player.status }}">{{ player.name }}</span>
                                                        {% else %}
                                                            <span class="no-unique">-</span>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                <div class="unique-team unique-team-2">
                                                    <span class="unique-label">{{ match.team_2_name }}:</span>
                                                    <div class="unique-players-list">
                                                        {% for player in match.team_2_unique %}
                                                            <span class="unique-player-tag status-{{ player.status }}">{{ player.name }}</span>
                                                        {% else %}
                                                            <span class="no-unique">-</span>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Mobile Cards View -->
                        <div class="mobile-fixtures mobile-only">
                            {% for match in data.fixtures %}
                            <div class="fixture-card" onclick="toggleMobileUnique({{ loop.index }})">
                                <div class="fixture-card-main">
                                    <!-- Team 1 -->
                                    <div class="fixture-team {% if match.winner == 1 %}winner{% endif %}">
                                        <a href="https://fantasy.premierleague.com/entry/{{ match.entry_1 }}/event/{{ data.gameweek }}" target="_blank" class="fixture-team-name" onclick="event.stopPropagation()">
                                            {% if match.winner == 1 %}‚úì {% endif %}{{ match.team_1_name }}
                                        </a>
                                        <div class="fixture-team-details">
                                            <span class="fixture-captain">üëë {{ match.team_1_captain }}</span>
                                            <span class="fixture-chip {% if match.team_1_chip_active %}active{% endif %}">{{ match.team_1_chip }}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Score -->
                                    <div class="fixture-score-block">
                                        <div class="fixture-scores">
                                            <span class="fixture-pts {% if match.winner == 1 %}winning{% endif %}">{{ match.team_1_points }}</span>
                                            <span class="fixture-separator">-</span>
                                            <span class="fixture-pts {% if match.winner == 2 %}winning{% endif %}">{{ match.team_2_points }}</span>
                                        </div>
                                        <div class="fixture-diff">
                                            <span class="fixture-diff-badge {% if match.winner == 1 %}diff-left{% elif match.winner == 2 %}diff-right{% endif %}">
                                                {% if match.winner == 1 %}‚óÄ{% elif match.winner == 2 %}‚ñ∂{% endif %} {{ match.points_diff }}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- Team 2 -->
                                    <div class="fixture-team {% if match.winner == 2 %}winner{% endif %}">
                                        <a href="https://fantasy.premierleague.com/entry/{{ match.entry_2 }}/event/{{ data.gameweek }}" target="_blank" class="fixture-team-name" onclick="event.stopPropagation()">
                                            {% if match.winner == 2 %}‚úì {% endif %}{{ match.team_2_name }}
                                        </a>
                                        <div class="fixture-team-details">
                                            <span class="fixture-captain">üëë {{ match.team_2_captain }}</span>
                                            <span class="fixture-chip {% if match.team_2_chip_active %}active{% endif %}">{{ match.team_2_chip }}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Unique Players (Hidden by default) -->
                                <div class="fixture-card-unique" id="mobile-unique-{{ loop.index }}" style="display: none;">
                                    <div class="unique-section">
                                        <div class="unique-header">{{ match.team_1_name }}</div>
                                        <div class="unique-players">
                                            {% for player in match.team_1_unique %}
                                                <span class="unique-tag status-{{ player.status }}">{{ player.name }}</span>
                                            {% else %}
                                                <span class="unique-none">ŸÑÿß ŸäŸàÿ¨ÿØ</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="unique-section">
                                        <div class="unique-header">{{ match.team_2_name }}</div>
                                        <div class="unique-players">
                                            {% for player in match.team_2_unique %}
                                                <span class="unique-tag status-{{ player.status }}">{{ player.name }}</span>
                                            {% else %}
                                                <span class="unique-none">ŸÑÿß ŸäŸàÿ¨ÿØ</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="fixture-card-expand">
                                    <span class="expand-hint" id="expand-hint-{{ loop.index }}">‚ñº ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ ÿßŸÑŸÖŸÖŸäÿ≤ŸäŸÜ</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="no-data">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ®ÿßÿ±Ÿäÿßÿ™</div>
                    {% endif %}
                </section>

                <!-- Standings Section -->
                <section class="standings-section">
                    <h2 class="section-title">
                        üìä {% if data.is_live %}{{ ar.live_standings }}{% else %}{{ ar.standings }}{% endif %}
                        {% if data.is_live %}
                            <span class="live-badge">üî¥ {{ ar.live }}</span>
                        {% endif %}
                    </h2>
                    
                    <!-- Desktop Table -->
                    <div class="desktop-only">
                        {% include 'partials/standings_table.html' %}
                    </div>
                    
                    <!-- Mobile Standings -->
                    <div class="mobile-standings mobile-only">
                        <div class="mobile-standings-header">
                            <span class="msh-rank">ŸÖ</span>
                            <span class="msh-name">ÿßŸÑŸÖÿØÿ±ÿ®</span>
                            <span class="msh-lp">ŸÜ.ÿØ</span>
                            <span class="msh-gw">ŸÜ.ÿ¨</span>
                        </div>
                        {% for team in data.standings %}
                        <div class="mobile-standing-row {% if loop.index <= 3 %}top-three{% endif %} {% if team.result == 'W' %}row-win{% elif team.result == 'L' %}row-loss{% endif %}" onclick="toggleStandingDetails({{ loop.index }})">
                            <div class="mobile-standing-main">
                                <span class="ms-rank">
                                    {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% else %}{{ team.rank }}{% endif %}
                                    {% if team.rank_change and team.rank_change > 0 %}
                                        <span class="rank-up">‚Üë{{ team.rank_change }}</span>
                                    {% elif team.rank_change and team.rank_change < 0 %}
                                        <span class="rank-down">‚Üì{{ team.rank_change|abs }}</span>
                                    {% endif %}
                                </span>
                                <span class="ms-name">
                                    <a href="https://fantasy.premierleague.com/entry/{{ team.entry_id }}/event/{{ data.gameweek }}" target="_blank" onclick="event.stopPropagation()">{{ team.player_name }}</a>
                                </span>
                                <span class="ms-lp">{{ team.projected_league_points }}</span>
                                <span class="ms-gw">{{ team.current_gw_points or '-' }}</span>
                            </div>
                            <div class="mobile-standing-details" id="standing-details-{{ loop.index }}" style="display: none;">
                                <div class="ms-detail">
                                    <span class="ms-label">{{ ar.captain }}:</span>
                                    <span class="ms-value">üëë {{ team.captain or '-' }}</span>
                                </div>
                                <div class="ms-detail">
                                    <span class="ms-label">{{ ar.chip }}:</span>
                                    <span class="ms-value chip-badge {% if team.chip_active %}active{% endif %}">{{ team.chip or '-' }}</span>
                                </div>
                                {% if data.is_live %}
                                <div class="ms-detail">
                                    <span class="ms-label">{{ ar.result }}:</span>
                                    <span class="ms-value">
                                        {% if team.result == 'W' %}üü¢ {{ ar.winner }}{% elif team.result == 'L' %}üî¥ {{ ar.loser }}{% elif team.result == 'D' %}üü° {{ ar.draw }}{% else %}-{% endif %}
                                    </span>
                                </div>
                                <div class="ms-detail">
                                    <span class="ms-label">{{ ar.opponent }}:</span>
                                    <span class="ms-value">{{ team.opponent or '-' }}</span>
                                </div>
                                {% endif %}
                                <div class="ms-detail">
                                    <span class="ms-label">{{ ar.total_points }}:</span>
                                    <span class="ms-value">{{ '{:,}'.format(team.total_points) if team.total_points else '-' }}</span>
                                </div>
                                <div class="ms-detail">
                                    <span class="ms-label">{{ ar.overall_rank }}:</span>
                                    <span class="ms-value">{{ '{:,}'.format(team.overall_rank) if team.overall_rank else '-' }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>
            </div>
        {% endif %}
    </main>

    <!-- Footer (Desktop only) -->
    <footer class="footer desktop-only">
        <p>{{ ar.copyright }}</p>
        {% if data.is_live %}
            <p class="refresh-note">üîÑ {{ ar.auto_refresh }}</p>
        {% endif %}
        <p class="timestamp" id="timestamp"></p>
    </footer>
    
    <script>
        // Toggle unique players row (Desktop)
        function toggleUnique(index) {
            const row = document.getElementById('unique-row-' + index);
            const btn = event.target;
            if (row.style.display === 'none') {
                row.style.display = 'table-row';
                btn.textContent = '‚ñ≤';
                btn.classList.add('active');
            } else {
                row.style.display = 'none';
                btn.textContent = '‚ñº';
                btn.classList.remove('active');
            }
        }
        
        // Toggle unique players (Mobile)
        function toggleMobileUnique(index) {
            const uniqueDiv = document.getElementById('mobile-unique-' + index);
            const hint = document.getElementById('expand-hint-' + index);
            if (uniqueDiv.style.display === 'none') {
                uniqueDiv.style.display = 'block';
                hint.textContent = '‚ñ≤ ÿ•ÿÆŸÅÿßÿ°';
            } else {
                uniqueDiv.style.display = 'none';
                hint.textContent = '‚ñº ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ ÿßŸÑŸÖŸÖŸäÿ≤ŸäŸÜ';
            }
        }
        
        // Toggle standing details (Mobile)
        function toggleStandingDetails(index) {
            const details = document.getElementById('standing-details-' + index);
            const row = details.parentElement;
            if (details.style.display === 'none') {
                // Close all other open details
                document.querySelectorAll('.mobile-standing-details').forEach(d => {
                    d.style.display = 'none';
                    d.parentElement.classList.remove('expanded');
                });
                details.style.display = 'block';
                row.classList.add('expanded');
            } else {
                details.style.display = 'none';
                row.classList.remove('expanded');
            }
        }
        
        // Refresh dashboard
        function refreshDashboard() {
            const btn = document.getElementById('refresh-btn');
            btn.classList.add('spinning');
            btn.disabled = true;
            location.reload();
        }
        
        // Auto-refresh every 60 seconds if live
        {% if data.is_live %}
        setTimeout(() => location.reload(), 60000);
        {% endif %}
        
        // Update timestamp
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const timestampEl = document.getElementById('timestamp');
        if (timestampEl) {
            timestampEl.textContent = '{{ ar.last_updated }}: ' + timeStr;
        }
    </script>
</body>
</html>
